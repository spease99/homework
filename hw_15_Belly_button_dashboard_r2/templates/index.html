<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
  <link rel="stylesheet" href="styles.css">  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
     
  <div class="container">
    
    <!-- date selector -->  
    <div class="row">
      <div class="col-md-12">
        <h1>Belly Botton Biodiversity</h1>
          <h1>Dashboard</h1>
          <h3>Use the interactive charts below to explore the dataset</h3>
          <h4>Are you in the data set?</h4>
      </div>    
    </div>

    <div class="row">
      <div class="col-sm-2">
               <h5> Select Sample </h5> 
               <select id="select_sample_id", onchange="meta_changed(this.value), pie_changed(this.value),buildGauge(this.value)"></select>
               
                <h4 style="font-family: fantasy;">Meta DATA</h4>
                <p id="age" style="font-family: fantasy;"> AGE: </p>
                <p id="BBTYPE" style="font-family: fantasy;"></p>
                <p id="ethinic" style="font-family: fantasy;"></p>
                <p id="gender" style="font-family: fantasy;"></p>
                <p id="location" style="font-family: fantasy;"></p>
                <p id="sampleid" style="font-family: fantasy;"></p>
                <div style="height:20px"></div>
        </div>      

      <div class="col-sm-5">
               <div id="pie_chart_id"></div>
      </div>
        
      <div class="col-sm-5">
               <h5> Belly Botton Washing Frequency </h5> 
               <div id="gauge"></div>
        </div>      
    </div>
  </div>
    
  <!-- <script src="data.js" type="text/javascript"></script>  -->
  <!--- <script type='text/javascript' src='/templates/script.js'></script>  -->                                          
  <script type="text/javascript">
       // Creating drop down
          var url = "/names"
          Plotly.d3.json(url, function(error, response){
               var ddlItems = document.getElementById("select_sample_id"), itemArray=response.samples;            
               for (var i=0; i<itemArray.length; i++) {
                   var opt = itemArray[i];
                   var el = document.createElement("option");
                   el.textContent = opt;
                   el.value = opt;
                   ddlItems.appendChild(el);
               }
           });
           
          function meta_changed(sample_num){
              url = '/metadata/'+sample_num
              //console.log("hello from meta_changed")
              //console.log("sample_num = " + sample_num)
              
               Plotly.d3.json(url, function(error, response){
                    //console.log(response)
                    //console.log(response.AGE)
                    //set age field
                    document.getElementById("age").innerHTML = "AGE:" + " " + response.AGE
                    document.getElementById("BBTYPE").innerHTML = "BBTYPE:" + " " + response.BBTYPE
                    document.getElementById("ethinic").innerHTML = "ETHNICITY:" + " " + response.ETHNICITY
                    document.getElementById("gender").innerHTML = "GENDER:" + " " + response.GENDER
                    document.getElementById("location").innerHTML = "LOCATION:" + " " + response.LOCATION
                    document.getElementById("sampleid").innerHTML = "SAMPLEID:" + " " + response.SAMPLEID
                })
           };
           
           function pie_changed(sample_num){
              url = '/samples/'+sample_num
              //console.log("hello from pie_changed")
              //console.log("sample_num = " + sample_num)
              url = "/samples/" + sample_num
              //console.log("url = " + url)
              d3.json(url, function(error, response) {
                    if (error) console.log(error);
                
                    //console.log(response);
                    // Data slices
                    var idSlice = response.otu_id.slice(0,10);
                    //console.log(idSlice)
                    var valueSlice = response.sample_values.slice(0,10);
                    //console.log(valueSlice);

                    // Pie data
                    var pieIds = [];
                    var pieValues = [];
                    for (var i = 0; i < valueSlice.length; i++) {
                        if (valueSlice[i] != 0) {
                            pieIds.push(idSlice[i]);
                            pieValues.push(valueSlice[i]);
                        };
                     };
                    
                    var data = [{
                                values:pieValues,
                                labels: pieIds,
                                type: "pie"
                      }];
                      
                      var layout = {
                        height: 300,
                        width: 400
                      };

                      Plotly.plot("pie_chart_id", data, layout);

              })
          }
          
        function speedometer_changed(sample_num){
            console.log('hello from speedometer')
            console.log("sample_num = " + sample_num)
            url = '/wfreq/'+sample_num
            console.log('url = ' + url)
            d3.json(url, function(error, wfreq){
                console.log('wfreq = ' + wfreq)
            })
        }
        
        function buildGauge(sample) {
            console.log('hello from buildGauge')
            console.log("sample = " + sample)
            url = '/wfreq/'+sample
            console.log('url = ' + url)
            
            //Plotly.d3.json(`/wfreq/${sample}`, function(error, wfreq) {
            Plotly.d3.json(url, function(error, wfreq) {
                if (error) return console.warn(error);
                // Enter the washing frequency between 0 and 180
                var level = wfreq*20;
                // Trig to calc meter point
                var degrees = 180 - level,
                    radius = .5;
                var radians = degrees * Math.PI / 180;
                var x = radius * Math.cos(radians);
                var y = radius * Math.sin(radians);
                // Path: may have to change to create a better triangle
                var mainPath = 'M -.0 -0.05 L .0 0.05 L ',
                    pathX = String(x),
                    space = ' ',
                    pathY = String(y),
                    pathEnd = ' Z';
                var path = mainPath.concat(pathX,space,pathY,pathEnd);
                var data = [{ type: 'scatter',
                x: [0], y:[0],
                    marker: {size: 12, color:'850000'},
                    showlegend: false,
                    name: 'Freq',
                    text: level,
                    hoverinfo: 'text+name'},
                { values: [50/9, 50/9, 50/9, 50/9, 50/9, 50/9, 50/9, 50/9, 50/9, 50],
                rotation: 90,
                text: ['8-9', '7-8', '6-7', '5-6', '4-5', '3-4', '2-3', '1-2', '0-1', ''],
                textinfo: 'text',
                textposition:'inside',
                marker: {
                    colors:[
                        'rgba(0, 105, 11, .5)', 'rgba(10, 120, 22, .5)',
                        'rgba(14, 127, 0, .5)', 'rgba(110, 154, 22, .5)',
                        'rgba(170, 202, 42, .5)', 'rgba(202, 209, 95, .5)',
                        'rgba(210, 206, 145, .5)', 'rgba(232, 226, 202, .5)',
                        'rgba(240, 230, 215, .5)', 'rgba(255, 255, 255, 0)']},
                labels: ['8-9', '7-8', '6-7', '5-6', '4-5', '3-4', '2-3', '1-2', '0-1', ''],
                hoverinfo: 'label',
                hole: .5,
                type: 'pie',
                showlegend: false
                }];
                var layout = {
                shapes:[{
                   type: 'path',
                    path: path,
                    fillcolor: '850000',
                    line: {
                        color: '850000'
                    }
                    }],
                title: '<b>Belly Button Washing Frequency</b> <br> Scrubs per Week',
                height: 500,
                width: 500,
                xaxis: {zeroline:false, showticklabels:false,
                            showgrid: false, range: [-1, 1]},
                yaxis: {zeroline:false, showticklabels:false,
                            showgrid: false, range: [-1, 1]}
                };
                var GAUGE = document.getElementById('gauge');
                Plotly.newPlot(GAUGE, data, layout);
            });

        }
        
  </script>
  
  <!-- <script src="index.js" type="text/javascript"></script> -->
    
</body>

</html>
